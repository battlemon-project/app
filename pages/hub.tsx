import Head from 'next/head'
import Header from '../components/Header'
import Footer from '../components/Footer'
import Loader from '../components/Loader'
import dynamic from 'next/dynamic'
import { Suspense, useEffect, useState } from 'react'
import { useRecoilState } from 'recoil';
import { loaderState } from '../atoms/loaderState';
import { ethos } from 'ethos-connect';
import type { JsonRpcProvider, SuiObject, SuiMoveObject } from "@mysten/sui.js";

const HubScene = dynamic(() => import('../scenes/HubScene'), {
  suspense: true,
})

export default function Hub() {
  const [ loader, setLoader ] = useRecoilState(loaderState);
  const [ lemons, setLemons ] = useState<SuiMoveObject[]>([]);
  const { provider }: { provider: JsonRpcProvider} = ethos.useProviderAndSigner()
  const { wallet } = ethos.useWallet();

  const refreshLemons = async () => {
    if (!wallet?.address) {
      setLoader((loader) => [false, loader[1]]);
      return [];
    }
    const list: SuiMoveObject [] = [];
    const objects = await provider.getObjectsOwnedByAddress(wallet.address)
    console.log(objects)
    for (const object of objects.filter(object => object.type.includes('lemon'))) {
      let fullObject = await provider.getObject(object.objectId);
      let { data } = fullObject.details as SuiObject
      list.push(data as SuiMoveObject)
    }
    setLoader((loader) => [false, loader[1]]);
    setLemons(list.sort((a,b) => a.fields.created - b.fields.created ))
  }

  useEffect(() => {
    refreshLemons();
  }, [wallet?.address])

  const handleMint = async () => {
    if (!wallet) return;
    const signableTransaction = {
      kind: 'moveCall' as const,
      data: {
        packageObjectId: '0xcadf98b9d718eec44a431798019b64a101ea76df',
        module: 'lemon',
        function: 'create_lemon',
        typeArguments: [],
        arguments: [
          '0x1485d9f2cf70808655fa172fa8c27a253cac7498',
        ],
        gasBudget: 10000,
      },
    }
  
    await wallet.signAndExecuteTransaction(signableTransaction);
    await refreshLemons();
  }


  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Header />
      
      { wallet?.address && 
        <div className="sticky-top text-center d-inline-block position-absolute" style={{ zIndex: 980, left: '50%', top: '90px', transform: 'translateX(-50%)' }}>
          <button className="btn btn-lg btn-light px-4" onClick={handleMint}>Mint NFT (Devnet)</button> 
        </div>
      }

      <Suspense fallback={<Loader />}>
        <HubScene lemons={lemons} />
      </Suspense>
      {loader[0] || loader[1] && <Loader />}

      <Footer />
    </>
  )
}
